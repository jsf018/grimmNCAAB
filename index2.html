<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Grimm</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{ --bg:#0a0a0a; --fg:#f8fafc; --muted:#94a3b8; --line:#1f2937; --card:#0f1115; --elev:#111318; --pos:#10b981; --neg:#ef4444; }
  .light{ --bg:#ffffff; --fg:#0b1220; --muted:#6b7280; --line:#e5e7eb; --card:#ffffff; --elev:#f8fafc; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;line-height:1.45}
  .container{max-width:1200px;margin:0 auto;padding:16px}
  header{position:sticky;top:0;z-index:10;background:color-mix(in oklab, var(--bg) 92%, transparent);backdrop-filter:blur(6px);border-bottom:1px solid var(--line)}
  .nav{display:flex;align-items:center;gap:12px}
  .brand{display:flex;align-items:center;gap:8px;padding:10px 0}
  .logo{width:18px;height:18px;border:1px solid var(--fg);border-radius:4px;display:grid;place-items:center;font-family:"IBM Plex Mono",monospace;font-size:10px;font-weight:700}
  .title{font-weight:600}
  .btn{appearance:none;border:1px solid var(--line);background:var(--card);color:var(--fg);padding:8px 12px;border-radius:10px;font-size:12px;font-weight:600;cursor:pointer}
  .btn:hover{border-color:color-mix(in oklab, var(--fg) 18%, var(--line))}
  .btn.active{border-color:var(--fg)} .spacer{flex:1}
  .page{display:none;padding:14px 0} .page.active{display:block}
  .grid{display:grid;gap:12px} .grid.c2{grid-template-columns:repeat(2,minmax(0,1fr))} .grid.c3{grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width:900px){.grid.c2,.grid.c3{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
  .card h2{margin:0 0 8px 0;font-size:14px;letter-spacing:.06em;text-transform:uppercase}
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{padding:10px 8px;border-bottom:1px solid var(--line)} th{text-align:left;color:var(--muted);font-weight:600;letter-spacing:.06em;text-transform:uppercase}
  tr:hover td{background:var(--elev)} .mono{font-family:"IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .pos{color:var(--pos)} .neg{color:var(--neg)}
  .badge{display:inline-flex;align-items:center;justify-content:center;min-width:28px;height:20px;padding:0 8px;border:1px solid var(--line);border-radius:999px;font-weight:700;font-size:11px;line-height:1}
  .chip{padding:6px 10px;border:1px solid var(--line);border-radius:999px;font-size:12px;cursor:pointer} .chip.active{border-color:var(--fg)}
  .selection{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px}
  .sel{display:flex;gap:8px;padding:8px;border:1px solid var(--line);border-radius:10px;align-items:center;background:var(--card)} .sel input{accent-color:var(--fg);cursor:pointer}
  .form-row{display:grid;grid-template-columns:120px 1fr 120px;gap:8px;align-items:center;margin-bottom:8px}
  .input{width:100%;padding:8px 10px;background:var(--elev);color:var(--fg);border:1px solid var(--line);border-radius:8px;font-size:12px}
  .game-card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:8px}
  .game-teams{display:flex;flex-direction:column;gap:6px}
  .game-team{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-radius:6px;transition:background .15s}
  .game-team.winner{background:var(--elev);border-left:3px solid var(--pos)}
  .game-team-name{display:flex;align-items:center;gap:6px;font-weight:500}
  .game-score{font-size:16px;font-weight:700;font-family:"IBM Plex Mono",monospace}
  .game-info{display:flex;justify-content:space-between;align-items:center;padding-top:6px;border-top:1px solid var(--line);font-size:11px;color:var(--muted)}
  .games-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
  @media (max-width:640px){.games-grid{grid-template-columns:1fr}}

</style>
</head>
<body>
  <header>
    <div class="container nav">
      <div class="brand"><div class="logo">Φ</div><div class="title mono">GRIMM</div></div>
      <nav>
        <button class="btn active" data-page="standings">Standings</button>
        <button class="btn" data-page="managers">Managers</button>
        <button class="btn" data-page="schedule">Schedule</button>
        <button class="btn" data-page="settings">Settings</button>
      </nav>
      <div class="spacer"></div>
      <button class="btn" id="themeToggle" title="Toggle theme">◑</button>
    </div>
  </header>

  <main class="container">
    <section id="standings" class="page active">
      <div class="grid c2">
        <div class="card">
          <h2>League Standings</h2>
          <table id="standingsTable"><thead><tr>
            <th>Rank</th><th>Manager</th><th>Points</th><th>Point Diff.</th><th>Record</th>
          </tr></thead><tbody></tbody></table>
        </div>
        <div class="card">
          <h2>Head‑to‑Head</h2>
          <div id="h2hRecords" class="grid c2"></div>
        </div>
      </div>
    </section>

    <section id="managers" class="page">
      <div id="managersList" class="grid c2"></div>
    </section>

    <section id="teamDetail" class="page">
      <a href="#" class="btn" data-page="managers">← Back</a>
      <div id="teamDetailContent" class="card" style="margin-top:12px"></div>
    </section>

    <section id="schedule" class="page">
      <div class="card">
        <h2>Weekly Schedule</h2>
        <div id="weekSelector" class="week-tabs" style="margin-bottom:10px"></div>
        <div id="scheduleContent" class="grid"></div>
      </div>
    </section>

    <section id="settings" class="page">
      <div class="grid c2">
        <div class="card">
          <h2>Upload Data</h2>
          <div class="mono" style="margin-bottom:8px;color:var(--muted)">gamelog.json • teamid.json • rosters.json</div>
          <input type="file" id="gamelogFile" accept=".json" style="margin-bottom:8px" />
          <input type="file" id="teamidFile" accept=".json" style="margin-bottom:8px" />
          <input type="file" id="rosterFile" accept=".json" style="margin-bottom:8px" />
          <div style="display:flex;gap:8px"><button class="btn" id="loadFiles">Load Files</button><button class="btn" id="resetLS">Reset Local Data</button></div>
        </div>
        <div class="card">
          <h2>Active Teams (10 / Manager)</h2>
          <div id="teamSelectionContent"></div>
        </div>
        <div class="card" style="grid-column:1/-1">
          <h2>League Managers</h2>
          <div id="managerSettings"></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" id="saveManagers">Save Manager Settings</button>
            <button class="btn" id="randomColors">Randomize Colors</button>
            <button class="btn" id="resetColors">Reset Colors</button>
          </div>
        </div>
      </div>
    </section>
  </main>

<script>
/***** THEME & NAV *****/
(function(){
  const savedTheme = localStorage.getItem('theme');
  if(savedTheme === 'light'){ document.body.classList.add('light'); }
  document.getElementById('themeToggle')?.addEventListener('click', ()=>{
    document.body.classList.toggle('light');
    localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
  });
})();

function showPage(id){ document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById(id)?.classList.add('active'); document.querySelectorAll('nav .btn').forEach(b=>{ b.classList.toggle('active', b.dataset.page===id); }); }
[...document.querySelectorAll('[data-page]')].forEach(b=>b.addEventListener('click',e=>{const id=b.dataset.page;if(id){e.preventDefault();showPage(id)}}));

/***** DATA *****/
let teamIdData = {}; let teamIdArray = []; let rosterData = {}; let gameLogData = []; let activeRosters = {};
const idToTeam = {};
let managerMeta = JSON.parse(localStorage.getItem('managerMeta')) || { JF:{name:'JF', color:'#2563eb'}, JR:{name:'JR', color:'#16a34a'}, JS:{name:'JS', color:'#db2777'}, GK:{name:'GK', color:'#f59e0b'} };
function updateIdToTeam(){ Object.keys(idToTeam).forEach(k=>delete idToTeam[k]); Object.entries(teamIdData).forEach(([k,v])=>idToTeam[v]=k); }
function getManagerForTeam(teamId){ for(const [m,teams] of Object.entries(activeRosters)){ if((teams||[]).includes(teamId)) return m; } return null; }
function getManagerName(m){ return managerMeta[m]?.name || m; }
function getManagerColor(m){ return managerMeta[m]?.color || '#444444'; }

(async function initialize(){
  // Try to load from localStorage first, otherwise fetch from JSON files
  const savedTeamId = localStorage.getItem('teamIdData');
  const savedGameLog = localStorage.getItem('gameLogData');
  const savedActive = localStorage.getItem('activeRosters');
  const savedRoster = localStorage.getItem('rosterData');
  
  // Load teamid.json
  if(savedTeamId){ 
    teamIdArray = JSON.parse(savedTeamId); 
    teamIdData = {}; 
    teamIdArray.forEach(t=>teamIdData[t.TeamName]=t.team_id); 
  } else {
    try {
      const response = await fetch('teamid.json');
      if(response.ok) {
        teamIdArray = await response.json();
        teamIdData = {};
        teamIdArray.forEach(t=>teamIdData[t.TeamName]=t.team_id);
        localStorage.setItem('teamIdData', JSON.stringify(teamIdArray));
      }
    } catch(err) {
      console.error('Error loading teamid.json:', err);
      // Fallback to minimal data
      teamIdArray = [
        {TeamName:'Houston',team_id:113},{TeamName:'Gonzaga',team_id:102},{TeamName:'NC State',team_id:200},{TeamName:'Georgia',team_id:98},{TeamName:'Villanova',team_id:328},{TeamName:'BYU',team_id:35},{TeamName:'UAB',team_id:301},{TeamName:'Florida',team_id:86},{TeamName:'Dayton',team_id:65},{TeamName:"Saint Mary's",team_id:247},{TeamName:'Colorado St.',team_id:57},{TeamName:'South Florida',team_id:267},{TeamName:'Connecticut',team_id:59},{TeamName:'Alabama',team_id:4},{TeamName:'North Carolina',team_id:197},{TeamName:'Maryland',team_id:160},{TeamName:'VCU',team_id:326},{TeamName:'Illinois',team_id:118},{TeamName:'Iowa St.',team_id:126},{TeamName:'Louisville',team_id:150}
      ];
      teamIdData = {}; 
      teamIdArray.forEach(t=>teamIdData[t.TeamName]=t.team_id);
    }
  }
  
  // Load gamelog.json
  if(savedGameLog){ 
    gameLogData = JSON.parse(savedGameLog); 
  } else {
    try {
      const response = await fetch('gamelog.json');
      if(response.ok) {
        gameLogData = await response.json();
        localStorage.setItem('gameLogData', JSON.stringify(gameLogData));
      }
    } catch(err) {
      console.error('Error loading gamelog.json:', err);
      // Fallback to minimal data
      gameLogData = [
        {GAME:1,DATE:'11/03/2025',HOME:'Houston',HOME_ID:113,AWAY:'Lehigh',AWAY_ID:141,FAV_ID:113,SPREAD:36.5,HOME__1:75,AWAY__1:57},
        {GAME:2,DATE:'11/03/2025',HOME:'Gonzaga',HOME_ID:102,AWAY:'Texas Southern',AWAY_ID:292,FAV_ID:102,SPREAD:29.5,HOME__1:98,AWAY__1:43},
        {GAME:3,DATE:'11/08/2025',HOME:'Houston',HOME_ID:113,AWAY:'Towson',AWAY_ID:297,FAV_ID:'',SPREAD:'',HOME__1:'',AWAY__1:''}
      ];
    }
  }
  
  // Load rosters.json
  if(savedRoster) {
    rosterData = JSON.parse(savedRoster);
  } else {
    try {
      const response = await fetch('rosters.json');
      if(response.ok) {
        rosterData = await response.json();
        localStorage.setItem('rosterData', JSON.stringify(rosterData));
      }
    } catch(err) {
      console.error('Error loading rosters.json:', err);
      // Fallback to hardcoded data
      rosterData = { JF:[4,160,11,59,197,252,326,66,253,184,164,145,58,48,1,310,343,94,214,53,116,279,33,203,309,193,112,14,199,44,270], JR:[13,118,126,277,150,190,274,142,255,22,88,303,232,165,321,202,178,146,351,219,229,140,136,43,327,183,32,365,60,332,87], JS:[98,125,113,328,200,104,74,85,102,209,301,363,350,295,317,364,55,311,241,298,80,163,167,19,31,42,153,181,196,276,129], GK:[86,234,294,62,73,57,65,249,247,71,267,305,63,250,362,220,72,110,347,132,336,121,28,89,7,248,17,260,182,84,103] };
    }
  }
  
  activeRosters = savedActive ? JSON.parse(savedActive) : { JF: rosterData.JF.slice(0,10), JR: rosterData.JR.slice(0,10), JS: rosterData.JS.slice(0,10), GK: rosterData.GK.slice(0,10) };
  localStorage.setItem('activeRosters', JSON.stringify(activeRosters));
  localStorage.setItem('managerMeta', JSON.stringify(managerMeta));
  updateIdToTeam();
  displayAll();
})();

/***** HELPERS *****/
function readableTextColor(hex){ try{ const h=hex.replace('#',''); const r=parseInt(h.slice(0,2),16)||0,g=parseInt(h.slice(2,4),16)||0,b=parseInt(h.slice(4,6),16)||0; const Y=0.2126*r+0.7152*g+0.0722*b; return Y>140?'#111':'#fff'; }catch(e){ return '#fff'; } }
function badgeInitials(m){ const c=getManagerColor(m),tc=readableTextColor(c); return `<span class="badge" style="background:${c};color:${tc}">${m}</span>`; }
function badgeName(m){ const c=getManagerColor(m),tc=readableTextColor(c); const label=getManagerName(m); return `<span class="badge" style="background:${c};color:${tc}">${label}</span>`; }
function calculateSpreadCover(g){ if(!g.HOME__1||!g.AWAY__1||!g.SPREAD) return null; const home=+g.HOME__1,away=+g.AWAY__1,spread=+g.SPREAD; const margin=home-away; const favHome=g.FAV_ID===g.HOME_ID; return favHome ? (margin>spread) : (-margin>spread); }
function getGamePoints(g, teamId){ if(!g.HOME__1||!g.AWAY__1||!g.SPREAD) return {points:0,covered:null}; const covered=calculateSpreadCover(g); const manager=getManagerForTeam(teamId); const oppId=teamId===g.HOME_ID?g.AWAY_ID:g.HOME_ID; const oppManager=getManagerForTeam(oppId); const isFav=g.FAV_ID===teamId; const teamCovered=(isFav&&covered)||(!isFav&&!covered); if(manager===oppManager) return {points:0,covered:teamCovered}; if(oppManager) return {points:teamCovered?3:0,covered:teamCovered}; return {points:teamCovered?1:0,covered:teamCovered}; }

/***** RENDERERS *****/
function displayStandings(){
  const s = {JF:{points:0,diff:0,covers:0,total:0},JR:{points:0,diff:0,covers:0,total:0},JS:{points:0,diff:0,covers:0,total:0},GK:{points:0,diff:0,covers:0,total:0}};
  gameLogData.forEach(g=>{ if(!g.HOME__1||!g.AWAY__1) return; const home=+g.HOME__1,away=+g.AWAY__1; [g.HOME_ID,g.AWAY_ID].forEach(t=>{ const m=getManagerForTeam(t); if(!m) return; const res=getGamePoints(g,t); s[m].points+=res.points; s[m].total+=1; if(res.covered) s[m].covers+=1; const diff=(t===g.HOME_ID)?(home-away):(away-home); s[m].diff+=diff; }); });
  const arr = Object.entries(s).map(([manager,stats])=>({manager,...stats})).sort((a,b)=> b.points!==a.points?b.points-a.points:b.diff-a.diff);
  const tbody=document.querySelector('#standingsTable tbody'); if(!tbody) return; tbody.innerHTML='';
  arr.forEach((row,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td class="mono">${String(i+1).padStart(2,'0')}</td><td>${badgeName(row.manager)}</td><td class="mono"><strong>${row.points}</strong></td><td class="mono ${row.diff>=0?'pos':'neg'}">${row.diff>0?'+':''}${row.diff}</td><td class="mono">${row.covers}-${row.total-row.covers}</td>`; tbody.appendChild(tr); });
}

function displayH2H(){
  const managers=['JF','JR','JS','GK']; const rec={}; managers.forEach(m1=>{rec[m1]={}; managers.forEach(m2=>{ if(m1!==m2) rec[m1][m2]={w:0,l:0}; });});
  gameLogData.forEach(g=>{ if(!g.HOME__1||!g.AWAY__1) return; const mH=getManagerForTeam(g.HOME_ID), mA=getManagerForTeam(g.AWAY_ID); if(mH&&mA&&mH!==mA){ const h=getGamePoints(g,g.HOME_ID).points; const a=getGamePoints(g,g.AWAY_ID).points; if(h>a){ rec[mH][mA].w++; rec[mA][mH].l++; } else { rec[mA][mH].w++; rec[mH][mA].l++; } }});
  const wrap=document.getElementById('h2hRecords'); if(!wrap) return; wrap.innerHTML='';
  managers.forEach(m1=>{ const card=document.createElement('div'); card.className='card'; const rows=managers.filter(m2=>m2!==m1).map(m2=>`<div class="mono" style="display:flex;justify-content:space-between"><span>${badgeInitials(m2)}</span><span>${rec[m1][m2].w}-${rec[m1][m2].l}</span></div>`).join(''); card.innerHTML=`<div class="mono" style="color:var(--muted);margin-bottom:6px">${getManagerName(m1)} vs</div>${rows}`; wrap.appendChild(card); });
}

function displayManagers(){
  const container=document.getElementById('managersList'); if(!container) return; container.innerHTML='';
  ['JF','JR','JS','GK'].forEach(m=>{
    const teamStats={}; (activeRosters[m]||[]).forEach(id=> teamStats[id]={pts:0,diff:0,g:0});
    gameLogData.forEach(g=>{ if(!g.HOME__1||!g.AWAY__1) return; [g.HOME_ID,g.AWAY_ID].forEach(t=>{ if((activeRosters[m]||[]).includes(t)){ const res=getGamePoints(g,t); const diff=(t===g.HOME_ID)?(+g.HOME__1-+g.AWAY__1):(+g.AWAY__1-+g.HOME__1); teamStats[t].pts+=res.points; teamStats[t].diff+=diff; teamStats[t].g+=1; } }); });
    const sorted=Object.entries(teamStats).sort((a,b)=> b[1].pts!==a[1].pts?b[1].pts-a[1].pts:b[1].diff-a[1].diff);
    const rows=sorted.map(([id,st])=>`<tr data-team="${id}" data-m="${m}"><td>${idToTeam[id]||id}</td><td class="mono"><strong>${st.pts}</strong></td><td class="mono ${st.diff>=0?'pos':'neg'}">${st.diff>0?'+':''}${st.diff}</td><td class="mono">${st.g}</td></tr>`).join('');
    const card=document.createElement('div'); card.className='card'; card.innerHTML=`<div class="grid c2" style="margin-bottom:8px"><div><div class="mono" style="color:var(--muted)">Manager</div><div>${badgeName(m)}</div></div></div><table><thead><tr><th>Team</th><th>Pts</th><th>Diff</th><th>Games</th></tr></thead><tbody>${rows}</tbody></table>`; container.appendChild(card);
  });
  container.querySelectorAll('tr[data-team]')?.forEach(r=>r.addEventListener('click',()=>{ const teamId=+r.dataset.team; const manager=r.dataset.m; showTeamDetail(teamId,manager); }));
}

function showTeamDetail(teamId, manager){
  const name=idToTeam[teamId]||teamId; const games=gameLogData.filter(g=>g.HOME_ID===teamId||g.AWAY_ID===teamId); let totalPts=0,totalDiff=0;
  const rows=games.map(g=>{ if(!g.HOME__1||!g.AWAY__1){ const isHome=g.HOME_ID===teamId; const oppId=isHome?g.AWAY_ID:g.HOME_ID; const opp=idToTeam[oppId]||oppId; const oppM=getManagerForTeam(oppId); return `<tr><td>${g.DATE}</td><td>${isHome?'vs':'@'} ${opp} ${oppM?badgeInitials(oppM):''}</td><td class="muted" colspan="4">Scheduled</td></tr>`; } const isHome=g.HOME_ID===teamId; const oppId=isHome?g.AWAY_ID:g.HOME_ID; const opp=idToTeam[oppId]||oppId; const oppM=getManagerForTeam(oppId); const ts=isHome?+g.HOME__1:+g.AWAY__1; const os=isHome?+g.AWAY__1:+g.HOME__1; const diff=ts-os; const won=diff>0; const res=getGamePoints(g,teamId); totalPts+=res.points; totalDiff+=diff; const isFav=g.FAV_ID===teamId; const spreadDisplay=g.SPREAD?`${isFav?'-':'+'}`+g.SPREAD:'—'; return `<tr><td>${g.DATE}</td><td>${isHome?'vs':'@'} ${opp} ${oppM?badgeInitials(oppM):''}</td><td class="${won?'pos':'neg'} mono">${won?'W':'L'} ${ts}-${os}</td><td class="mono ${diff>=0?'pos':'neg'}">${diff>0?'+':''}${diff}</td><td class="mono muted">${spreadDisplay}</td><td class="mono"><strong class="${res.covered?'pos':'neg'}">${res.points}</strong></td></tr>`; }).join('');
  const box=document.getElementById('teamDetailContent'); if(!box) return; box.innerHTML=`<h2 style="margin:0 0 8px 0">${name} ${badgeInitials(manager)} <span class="muted" style="margin-left:6px">(${getManagerName(manager)})</span></h2><table><thead><tr><th>Date</th><th>Opponent</th><th>Result</th><th>Diff</th><th>Spread</th><th>Pts</th></tr></thead><tbody>${rows}</tbody></table>`; showPage('teamDetail');
}

function displaySchedule(){
  const weeks={}; gameLogData.forEach(g=>{ const d=new Date(g.DATE); if(isNaN(d)) return; const monday=new Date(d); monday.setDate(d.getDate()-((d.getDay()+6)%7)); const key=monday.toISOString().split('T')[0]; (weeks[key] ||= []).push(g); });
  const keys=Object.keys(weeks).sort(); const sel=document.getElementById('weekSelector'); const content=document.getElementById('scheduleContent'); if(!sel||!content) return; sel.innerHTML=''; content.innerHTML='';
  function renderWeek(k){ content.innerHTML=''; const days={}; weeks[k].forEach(g=>{ (days[g.DATE] ||= []).push(g); }); Object.keys(days).sort().forEach(date=>{ const dateCard=document.createElement('div'); dateCard.className='card'; dateCard.innerHTML=`<div class="mono" style="color:var(--muted);margin-bottom:8px;font-weight:600">${date}</div><div class="games-grid" id="games-${date}"></div>`; content.appendChild(dateCard); const gamesGrid=document.getElementById(`games-${date}`); days[date].forEach(g=>{ const mA=getManagerForTeam(g.AWAY_ID); const mH=getManagerForTeam(g.HOME_ID); const awayName=idToTeam[g.AWAY_ID]||g.AWAY; const homeName=idToTeam[g.HOME_ID]||g.HOME; const finished=g.HOME__1&&g.AWAY__1; const awayScore=finished?+g.AWAY__1:null; const homeScore=finished?+g.HOME__1:null; const awayWon=finished&&awayScore>homeScore; const homeWon=finished&&homeScore>awayScore; const isLeague=mA&&mH; const gameCard=document.createElement('div'); gameCard.className='game-card'; let spreadInfo=''; if(finished&&g.SPREAD){ const covered=calculateSpreadCover(g); const favIsHome=g.FAV_ID===g.HOME_ID; const favIsAway=g.FAV_ID===g.AWAY_ID; const awayCovered=favIsAway?covered:!covered; const homeCovered=favIsHome?covered:!covered; spreadInfo=`<div style="font-size:10px;color:var(--muted);margin-top:2px">${favIsAway?'-':'+'}<span>${g.SPREAD}</span></div>`; const awaySpread=`<div style="font-size:10px;color:var(--muted);margin-top:2px">${favIsAway?'-':'+'}<span>${g.SPREAD}</span>${awayCovered?` <span style="color:var(--pos)">✓</span>`:''}</div>`; const homeSpread=`<div style="font-size:10px;color:var(--muted);margin-top:2px">${favIsHome?'-':'+'}<span>${g.SPREAD}</span>${homeCovered?` <span style="color:var(--pos)">✓</span>`:''}</div>`; let teamsHTML='<div class="game-teams">'; teamsHTML+=`<div class="game-team${awayWon?' winner':''}"><div><div class="game-team-name">${awayName}${mA?' '+badgeInitials(mA):''}</div>${awaySpread}</div>${finished?`<div class="game-score">${awayScore}</div>`:''}</div>`; teamsHTML+=`<div class="game-team${homeWon?' winner':''}"><div><div class="game-team-name">${homeName}${mH?' '+badgeInitials(mH):''}</div>${homeSpread}</div>${finished?`<div class="game-score">${homeScore}</div>`:''}</div>`; teamsHTML+='</div>'; let infoHTML='<div class="game-info">'; if(isLeague){ infoHTML+=`<span class="badge">League</span>`; } else { infoHTML+=`<span></span>`; } infoHTML+=`<span class="mono">FINAL</span>`; infoHTML+='</div>'; gameCard.innerHTML=teamsHTML+infoHTML; } else { let teamsHTML='<div class="game-teams">'; teamsHTML+=`<div class="game-team${awayWon?' winner':''}"><div class="game-team-name">${awayName}${mA?' '+badgeInitials(mA):''}</div>${finished?`<div class="game-score">${awayScore}</div>`:''}</div>`; teamsHTML+=`<div class="game-team${homeWon?' winner':''}"><div class="game-team-name">${homeName}${mH?' '+badgeInitials(mH):''}</div>${finished?`<div class="game-score">${homeScore}</div>`:''}</div>`; teamsHTML+='</div>'; let infoHTML='<div class="game-info">'; if(isLeague){ infoHTML+=`<span class="badge">League</span>`; } else { infoHTML+=`<span></span>`; } if(finished){ infoHTML+=`<span class="mono">FINAL</span>`; } else if(g.SPREAD){ const favName=idToTeam[g.FAV_ID]||g.FAV_ID; infoHTML+=`<span class="mono">${favName} -${g.SPREAD}</span>`; } else { infoHTML+=`<span class="mono">—</span>`; } infoHTML+='</div>'; gameCard.innerHTML=teamsHTML+infoHTML; } gamesGrid.appendChild(gameCard); }); }); }
  keys.forEach((k,i)=>{ const b=document.createElement('button'); b.className='chip'+(i===0?' active':''); b.textContent=`Week ${i+1}`; b.addEventListener('click',()=>{ [...sel.children].forEach(c=>c.classList.remove('active')); b.classList.add('active'); renderWeek(k); }); sel.appendChild(b); }); if(keys[0]) renderWeek(keys[0]);
}

/***** SETTINGS *****/
function displayTeamSelection(){ const container=document.getElementById('teamSelectionContent'); if(!container) return; const managers=['JF','JR','JS','GK']; let html=''; managers.forEach(m=>{ const all=rosterData[m]||[]; const selected=activeRosters[m]||[]; html+=`<div class='card'><div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:6px'><div>${badgeInitials(m)} <span style='margin-left:6px'>${getManagerName(m)}</span> — Active Teams</div><div class='mono' id='counter-${m}'>${selected.length} / 10</div></div><div class='selection' id='grid-${m}'>`; all.forEach(id=>{ const name=idToTeam[id]||id; const isSel=selected.includes(id); html+=`<label class='sel'><input type='checkbox' ${isSel?'checked':''} data-m='${m}' data-id='${id}'/> <span>${name}</span></label>`; }); html+=`</div><div style='display:flex;gap:8px;margin-top:8px'><button class='btn' data-save='${m}'>Save ${m}</button></div></div>`; }); container.innerHTML=html; container.querySelectorAll("input[type='checkbox']").forEach(cb=>cb.addEventListener('change',()=>{ const m=cb.dataset.m; const id=+cb.dataset.id; const arr=activeRosters[m] ||= []; const idx=arr.indexOf(id); if(cb.checked){ if(arr.length>=10){ cb.checked=false; alert('Select exactly 10 teams.'); return; } arr.push(id);} else { if(idx>-1) arr.splice(idx,1);} document.getElementById(`counter-${m}`).textContent=`${arr.length} / 10`; })); container.querySelectorAll('[data-save]').forEach(btn=>btn.addEventListener('click',()=>{ const m=btn.dataset.save; if((activeRosters[m]||[]).length!==10){ alert(`Please select exactly 10 teams for ${m}. Currently ${(activeRosters[m]||[]).length}.`); return;} localStorage.setItem('activeRosters', JSON.stringify(activeRosters)); alert(`${m} roster saved.`); })); }

function displayManagerSettings(){ const wrap=document.getElementById('managerSettings'); if(!wrap) return; const managers=['JF','JR','JS','GK']; wrap.innerHTML = managers.map(m=>{ const meta=managerMeta[m]||{name:m,color:'#444444'}; const tc=readableTextColor(meta.color); return `<div class='form-row'><label class='label' style='font-size:12px'><span class='badge' id='badge-${m}' style='background:${meta.color};color:${tc}'>${m}</span></label><input class='input' type='text' id='name-${m}' value='${meta.name}' placeholder='Display name for ${m}' /><input class='input' type='color' id='color-${m}' value='${meta.color}' /></div>`; }).join(''); managers.forEach(m=>{ const colorInput=document.getElementById(`color-${m}`); const badge=document.getElementById(`badge-${m}`); colorInput?.addEventListener('input',e=>{ const v=e.target.value; badge.style.background=v; badge.style.color=readableTextColor(v); }); }); }

document.getElementById('saveManagers')?.addEventListener('click', ()=>{ ['JF','JR','JS','GK'].forEach(m=>{ const name=(document.getElementById(`name-${m}`)?.value)||m; const color=(document.getElementById(`color-${m}`)?.value)||'#444444'; managerMeta[m]={name,color}; }); localStorage.setItem('managerMeta', JSON.stringify(managerMeta)); alert('Manager settings saved.'); displayAll(); });

document.getElementById('randomColors')?.addEventListener('click', ()=>{ const base=Math.floor(Math.random()*360); ['JF','JR','JS','GK'].forEach((m,i)=>{ const h=(base+i*90)%360, s=70, l=45; const color=hslToHex(h,s,l); const input=document.getElementById(`color-${m}`); const badge=document.getElementById(`badge-${m}`); if(input){ input.value=color; } if(badge){ badge.style.background=color; badge.style.color=readableTextColor(color);} }); });

document.getElementById('resetColors')?.addEventListener('click', ()=>{ const defaults={JF:'#2563eb',JR:'#16a34a',JS:'#db2777',GK:'#f59e0b'}; Object.entries(defaults).forEach(([m,color])=>{ const input=document.getElementById(`color-${m}`); const badge=document.getElementById(`badge-${m}`); if(input){ input.value=color; } if(badge){ badge.style.background=color; badge.style.color=readableTextColor(color);} }); });

function hslToHex(h,s,l){ s/=100; l/=100; const k=n=>(n+h/30)%12; const a=s*Math.min(l,1-l); const f=n=>l-a*Math.max(-1, Math.min(k(n)-3, Math.min(9-k(n),1))); const toHex=x=>Math.round(x*255).toString(16).padStart(2,'0'); return `#${toHex(f(0))}${toHex(f(8))}${toHex(f(4))}`; }

/***** FILES *****/
async function loadDataFiles(){ const gf=document.getElementById('gamelogFile')?.files?.[0]; const tf=document.getElementById('teamidFile')?.files?.[0]; const rf=document.getElementById('rosterFile')?.files?.[0]; try{ if(gf){ const txt=await gf.text(); gameLogData=JSON.parse(txt); localStorage.setItem('gameLogData', JSON.stringify(gameLogData)); } if(tf){ const txt=await tf.text(); teamIdArray=JSON.parse(txt); teamIdData={}; teamIdArray.forEach(t=>teamIdData[t.TeamName]=t.team_id); localStorage.setItem('teamIdData', JSON.stringify(teamIdArray)); } if(rf){ const txt=await rf.text(); rosterData=JSON.parse(txt); localStorage.setItem('rosterData', JSON.stringify(rosterData)); } updateIdToTeam(); alert('Files loaded.'); displayAll(); }catch(err){ alert('Error loading: '+err.message); } }

document.getElementById('loadFiles')?.addEventListener('click', loadDataFiles);

document.getElementById('resetLS')?.addEventListener('click', ()=>{ ['teamIdData','gameLogData','activeRosters','managerMeta','rosterData'].forEach(k=>localStorage.removeItem(k)); location.reload(); });

/***** BOOT *****/
function displayAll(){ displayStandings(); displayH2H(); displayManagers(); displaySchedule(); displayTeamSelection(); displayManagerSettings(); }

</script>
</body>
</html>
